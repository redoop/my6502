#!/bin/bash

echo "ğŸ§ª å¼ºåˆ¶ NMI æµ‹è¯•"
echo "================"
echo ""
echo "è¿™ä¸ªæµ‹è¯•ä¼šä¿®æ”¹ PPUCTRL æ¥å¼ºåˆ¶å¯ç”¨ NMI"
echo "æ³¨æ„ï¼šè¿™ä¸æ˜¯æ¸¸æˆçš„æ­£å¸¸è¡Œä¸ºï¼Œä»…ç”¨äºéªŒè¯ NMI åŠŸèƒ½"
echo ""

# åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯• ROM æ¥éªŒè¯ NMI
cat > /tmp/test_nmi.asm << 'EOF'
; ç®€å•çš„ NMI æµ‹è¯•ç¨‹åº
; è¿™ä¸ªç¨‹åºä¼šï¼š
; 1. è®¾ç½® PPUCTRL å¯ç”¨ NMI
; 2. ç­‰å¾… NMI è§¦å‘
; 3. åœ¨ NMI å¤„ç†ç¨‹åºä¸­ä¿®æ”¹å†…å­˜

.org $C000

RESET:
    SEI                 ; ç¦æ­¢ä¸­æ–­
    CLD                 ; æ¸…é™¤åè¿›åˆ¶æ¨¡å¼
    LDX #$FF
    TXS                 ; åˆå§‹åŒ–æ ˆæŒ‡é’ˆ
    
    ; ç­‰å¾… VBlank
@wait1:
    BIT $2002
    BPL @wait1
    
@wait2:
    BIT $2002
    BPL @wait2
    
    ; å¯ç”¨ NMI
    LDA #$90            ; NMI å¯ç”¨ + èƒŒæ™¯å›¾æ¡ˆè¡¨ 1
    STA $2000
    
    ; ä¸»å¾ªç¯ - ç­‰å¾… NMI
@loop:
    LDA $0200           ; è¯»å–æ ‡å¿—
    CMP #$42            ; æ£€æŸ¥æ˜¯å¦è¢« NMI ä¿®æ”¹
    BNE @loop
    
    ; NMI å·²è§¦å‘ï¼
    JMP @loop

NMI:
    ; NMI å¤„ç†ç¨‹åº
    LDA #$42
    STA $0200           ; è®¾ç½®æ ‡å¿—è¡¨ç¤º NMI å·²è§¦å‘
    RTI

.org $FFFA
.word NMI               ; NMI å‘é‡
.word RESET             ; Reset å‘é‡
.word 0                 ; IRQ å‘é‡
EOF

echo "æµ‹è¯•è¯´æ˜ï¼š"
echo "----------"
echo "åœ¨çœŸå®çš„ NES æ¨¡æ‹Ÿå™¨ä¸­ï¼Œè¿™ä¸ªæµ‹è¯•ä¼šï¼š"
echo "1. è®¾ç½® PPUCTRL = 0x90ï¼ˆå¯ç”¨ NMIï¼‰"
echo "2. ç­‰å¾… VBlank"
echo "3. NMI è§¦å‘åï¼Œåœ¨ 0x0200 å†™å…¥ 0x42"
echo "4. ä¸»å¾ªç¯æ£€æµ‹åˆ° 0x42 åç¡®è®¤ NMI å·¥ä½œ"
echo ""
echo "å½“å‰æ¸¸æˆï¼ˆMarioï¼‰æœªå¯ç”¨ NMI æ˜¯æ­£å¸¸çš„åˆå§‹åŒ–è¡Œä¸º"
echo ""
