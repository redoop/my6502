# PPU & APU 测试清单

参考 CPU 指令集测试方式，为 PPU 和 APU 建立完整的测试覆盖。

## 测试策略

### CPU 测试方式回顾
- **模块化测试**: 每个指令组独立测试模块
- **周期级测试**: 测试多周期指令的每个周期
- **边界测试**: 测试溢出、进位、零值等边界情况
- **覆盖率**: 每个操作码至少2-3个测试用例

### PPU/APU 测试方式
- **寄存器级测试**: 测试每个寄存器的读写
- **功能模块测试**: 测试渲染、精灵、滚动等独立功能
- **时序测试**: 测试扫描线、帧同步等时序
- **集成测试**: 测试完整的渲染流程

---

## PPU 测试清单

### 1. PPU 寄存器测试 (8个寄存器)

#### 1.1 PPUCTRL ($2000) - 控制寄存器
- [ ] 写入测试 - 基本写入
- [ ] NMI 使能位 (bit 7)
- [ ] 主/从模式 (bit 6)
- [ ] 精灵大小 (bit 5)
- [ ] 背景图案表地址 (bit 4)
- [ ] 精灵图案表地址 (bit 3)
- [ ] VRAM 地址增量 (bit 2)
- [ ] 名称表选择 (bit 1-0)

#### 1.2 PPUMASK ($2001) - 掩码寄存器
- [ ] 写入测试 - 基本写入
- [ ] 颜色强调 (bit 7-5)
- [ ] 精灵显示使能 (bit 4)
- [ ] 背景显示使能 (bit 3)
- [ ] 左侧精灵显示 (bit 2)
- [ ] 左侧背景显示 (bit 1)
- [ ] 灰度模式 (bit 0)

#### 1.3 PPUSTATUS ($2002) - 状态寄存器
- [ ] 读取测试 - 基本读取
- [ ] VBlank 标志 (bit 7)
- [ ] Sprite 0 Hit (bit 6)
- [ ] Sprite Overflow (bit 5)
- [ ] 读取清除 VBlank
- [ ] 读取清除地址锁存

#### 1.4 OAMADDR ($2003) - OAM 地址
- [ ] 写入测试 - 设置 OAM 地址
- [ ] 地址范围测试 (0x00-0xFF)

#### 1.5 OAMDATA ($2004) - OAM 数据
- [ ] 写入测试 - 写入 OAM 数据
- [ ] 读取测试 - 读取 OAM 数据
- [ ] 自动递增测试

#### 1.6 PPUSCROLL ($2005) - 滚动寄存器
- [ ] 第一次写入 - X 滚动
- [ ] 第二次写入 - Y 滚动
- [ ] 锁存切换测试
- [ ] 滚动范围测试 (0-255)

#### 1.7 PPUADDR ($2006) - VRAM 地址
- [ ] 第一次写入 - 高字节
- [ ] 第二次写入 - 低字节
- [ ] 锁存切换测试
- [ ] 地址范围测试 (0x0000-0x3FFF)

#### 1.8 PPUDATA ($2007) - VRAM 数据
- [ ] 写入测试 - 写入 VRAM
- [ ] 读取测试 - 读取 VRAM
- [ ] 自动递增测试 (+1)
- [ ] 自动递增测试 (+32)
- [ ] 读取缓冲测试

**寄存器测试总计: 40+ 测试用例**

---

### 2. PPU 内存测试 (5个区域)

#### 2.1 图案表 (Pattern Table)
- [ ] CHR ROM 加载测试
- [ ] 图案表 0 读取 ($0000-$0FFF)
- [ ] 图案表 1 读取 ($1000-$1FFF)
- [ ] 8x8 图块解码测试

#### 2.2 名称表 (Nametable)
- [ ] 名称表 0 读写 ($2000-$23FF)
- [ ] 名称表 1 读写 ($2400-$27FF)
- [ ] 名称表 2 读写 ($2800-$2BFF)
- [ ] 名称表 3 读写 ($2C00-$2FFF)
- [ ] 镜像测试 (水平/垂直)

#### 2.3 属性表 (Attribute Table)
- [ ] 属性表读写
- [ ] 2x2 图块调色板选择
- [ ] 属性字节解码测试

#### 2.4 调色板 (Palette)
- [ ] 背景调色板读写 ($3F00-$3F0F)
- [ ] 精灵调色板读写 ($3F10-$3F1F)
- [ ] 调色板镜像测试
- [ ] 背景色测试 ($3F00)

#### 2.5 OAM (Object Attribute Memory)
- [ ] OAM 读写测试 (256 字节)
- [ ] OAM DMA 传输测试
- [ ] 精灵属性解析测试

**内存测试总计: 20+ 测试用例**

---

### 3. PPU 渲染测试 (4个模块)

#### 3.1 背景渲染
- [ ] 单色背景渲染
- [ ] 图案表渲染
- [ ] 名称表渲染
- [ ] 属性表调色板应用
- [ ] 滚动渲染 (X 方向)
- [ ] 滚动渲染 (Y 方向)
- [ ] 名称表切换

#### 3.2 精灵渲染
- [ ] 单个精灵渲染
- [ ] 多个精灵渲染
- [ ] 精灵优先级测试
- [ ] 精灵翻转 (水平)
- [ ] 精灵翻转 (垂直)
- [ ] 精灵调色板选择
- [ ] 8x8 精灵模式
- [ ] 8x16 精灵模式

#### 3.3 Sprite 0 Hit
- [ ] Sprite 0 碰撞检测
- [ ] 碰撞时机测试
- [ ] 碰撞标志清除

#### 3.4 渲染优先级
- [ ] 背景 vs 精灵优先级
- [ ] 精灵间优先级
- [ ] 透明色处理

**渲染测试总计: 25+ 测试用例**

---

### 4. PPU 时序测试 (3个方面)

#### 4.1 扫描线时序
- [ ] 可见扫描线 (0-239)
- [ ] Post-render 扫描线 (240)
- [ ] VBlank 扫描线 (241-260)
- [ ] Pre-render 扫描线 (261)

#### 4.2 像素时序
- [ ] 像素计数器 (0-340)
- [ ] 像素输出时序
- [ ] 空闲周期

#### 4.3 帧同步
- [ ] VBlank 开始时机
- [ ] VBlank 结束时机
- [ ] NMI 触发时机
- [ ] 帧计数器

**时序测试总计: 15+ 测试用例**

---

## APU 测试清单

### 1. APU 寄存器测试 (20个寄存器)

#### 1.1 Pulse 1 通道 ($4000-$4003)
- [ ] $4000 - 占空比、包络、音量
- [ ] $4001 - 扫描单元
- [ ] $4002 - 定时器低字节
- [ ] $4003 - 定时器高字节、长度计数器

#### 1.2 Pulse 2 通道 ($4004-$4007)
- [ ] $4004 - 占空比、包络、音量
- [ ] $4005 - 扫描单元
- [ ] $4006 - 定时器低字节
- [ ] $4007 - 定时器高字节、长度计数器

#### 1.3 Triangle 通道 ($4008-$400B)
- [ ] $4008 - 线性计数器
- [ ] $400A - 定时器低字节
- [ ] $400B - 定时器高字节、长度计数器

#### 1.4 Noise 通道 ($400C-$400F)
- [ ] $400C - 包络、音量
- [ ] $400E - 模式、周期
- [ ] $400F - 长度计数器

#### 1.5 DMC 通道 ($4010-$4013)
- [ ] $4010 - 频率、循环、IRQ
- [ ] $4011 - 直接加载
- [ ] $4012 - 样本地址
- [ ] $4013 - 样本长度

#### 1.6 控制寄存器 ($4015, $4017)
- [ ] $4015 - 通道使能/状态
- [ ] $4017 - 帧计数器

**寄存器测试总计: 20+ 测试用例**

---

### 2. APU 功能模块测试 (7个模块)

#### 2.1 包络生成器 (Envelope)
- [ ] 包络启动测试
- [ ] 包络衰减测试
- [ ] 循环模式测试
- [ ] 常量音量模式
- [ ] 分频器测试

#### 2.2 长度计数器 (Length Counter)
- [ ] 长度加载测试
- [ ] 长度递减测试
- [ ] Halt 标志测试
- [ ] 使能控制测试
- [ ] 长度查找表测试

#### 2.3 线性计数器 (Linear Counter)
- [ ] 重载值设置
- [ ] 计数器递减
- [ ] 重载标志测试
- [ ] 控制标志测试

#### 2.4 扫描单元 (Sweep)
- [ ] 扫描使能测试
- [ ] 扫描周期测试
- [ ] 扫描方向测试
- [ ] 移位量测试
- [ ] 静音检测

#### 2.5 定时器 (Timer)
- [ ] 定时器周期设置
- [ ] 定时器递减
- [ ] 定时器重载
- [ ] 输出频率测试

#### 2.6 帧计数器 (Frame Counter)
- [ ] 4步模式测试
- [ ] 5步模式测试
- [ ] Quarter frame 时钟
- [ ] Half frame 时钟
- [ ] IRQ 生成

#### 2.7 混音器 (Mixer)
- [ ] 单通道输出
- [ ] 多通道混音
- [ ] 音量平衡
- [ ] 输出范围测试

**功能模块测试总计: 35+ 测试用例**

---

### 3. APU 通道测试 (5个通道)

#### 3.1 Pulse 1/2 通道
- [ ] 方波生成测试
- [ ] 占空比测试 (12.5%, 25%, 50%, 75%)
- [ ] 频率测试
- [ ] 音量测试
- [ ] 扫描效果测试

#### 3.2 Triangle 通道
- [ ] 三角波生成测试
- [ ] 频率测试
- [ ] 线性计数器控制
- [ ] 超声波静音测试

#### 3.3 Noise 通道
- [ ] 噪声生成测试
- [ ] 周期模式测试
- [ ] 短周期模式测试
- [ ] 音量测试

#### 3.4 DMC 通道
- [ ] 样本播放测试
- [ ] 频率测试
- [ ] 循环模式测试
- [ ] IRQ 测试
- [ ] DMA 读取测试

**通道测试总计: 20+ 测试用例**

---

## 测试优先级

### 高优先级 (P0) - 基础功能
1. PPU 寄存器读写 (40 tests)
2. APU 寄存器读写 (20 tests)
3. PPU 内存访问 (20 tests)
4. APU 包络/长度计数器 (15 tests)

**P0 总计: ~95 测试用例**

### 中优先级 (P1) - 核心功能
1. PPU 背景渲染 (10 tests)
2. PPU 精灵渲染 (10 tests)
3. APU Pulse 通道 (10 tests)
4. APU Triangle 通道 (5 tests)

**P1 总计: ~35 测试用例**

### 低优先级 (P2) - 高级功能
1. PPU 时序测试 (15 tests)
2. PPU Sprite 0 Hit (5 tests)
3. APU Noise/DMC 通道 (10 tests)
4. APU 帧计数器 (5 tests)

**P2 总计: ~35 测试用例**

---

## 测试实现计划

### Phase 1: PPU 寄存器测试 (Week 1)
- 创建 PPURegisterTestModule
- 实现 40+ 寄存器测试
- 目标: 100% 寄存器覆盖

### Phase 2: APU 寄存器测试 (Week 1)
- 创建 APURegisterTestModule
- 实现 20+ 寄存器测试
- 目标: 100% 寄存器覆盖

### Phase 3: PPU 内存测试 (Week 2)
- 创建 PPUMemoryTestModule
- 实现 20+ 内存测试
- 目标: 覆盖所有内存区域

### Phase 4: APU 功能模块测试 (Week 2)
- 创建 APUEnvelopeTestModule
- 创建 APULengthCounterTestModule
- 创建 APULinearCounterTestModule
- 实现 35+ 功能测试

### Phase 5: PPU 渲染测试 (Week 3)
- 创建 PPURenderTestModule
- 实现 25+ 渲染测试
- 目标: 基本渲染功能验证

### Phase 6: APU 通道测试 (Week 3)
- 创建 APUPulseTestModule
- 创建 APUTriangleTestModule
- 实现 20+ 通道测试

### Phase 7: 集成测试 (Week 4)
- PPU 完整渲染流程
- APU 完整音频输出
- PPU + APU 协同测试

---

## 测试覆盖目标

| 模块 | 测试用例 | 覆盖率目标 |
|------|---------|-----------|
| PPU 寄存器 | 40+ | 100% |
| PPU 内存 | 20+ | 100% |
| PPU 渲染 | 25+ | 80% |
| PPU 时序 | 15+ | 60% |
| APU 寄存器 | 20+ | 100% |
| APU 功能模块 | 35+ | 90% |
| APU 通道 | 20+ | 80% |
| **总计** | **175+** | **85%** |

---

## 参考资料

- [NES Dev Wiki - PPU](http://wiki.nesdev.com/w/index.php/PPU)
- [NES Dev Wiki - APU](http://wiki.nesdev.com/w/index.php/APU)
- CPU 指令测试实现: `src/test/scala/cpu/instructions/`
- 现有 PPU 测试: `src/test/scala/nes/PPUv3Test.scala`
- 现有 APU 测试: `src/test/scala/nes/APUTest.scala`
