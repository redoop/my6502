# 下一步行动计划

## 当前情况

### 成就 ✅
- 性能优化成功：0.7 FPS → 28 FPS (40x 提升)
- CPU 正常执行指令
- PPU 寄存器可读写
- SDL 显示系统正常

### 问题 ⚠️
- Donkey Kong 初始化循环过长（7000+ 帧仍未完成）
- PPUMASK 保持在 0x6，未达到 0x18（渲染启用）
- 无法确定循环是否会自然退出

## 三个可能的方向

### 方向 1: 继续调试 Donkey Kong 🔍

**目标**: 找出为什么初始化循环这么长

**行动**:
1. 检查 NMI 中断是否正确触发
   ```bash
   bash scripts/monitor_nmi.sh
   ```

2. 分析循环代码结构
   ```bash
   bash scripts/analyze_loop_code.sh
   ```

3. 监控内存变化，看游戏是否在更新状态

4. 反汇编 ROM，理解循环的退出条件

**优点**: 彻底理解问题
**缺点**: 可能需要大量时间

### 方向 2: 测试其他 ROM 🎮

**目标**: 确定问题是游戏特定的还是模拟器通用问题

**行动**:
1. 测试 Super Mario Bros
   ```bash
   bash scripts/test_mario.sh
   ```

2. 如果 Mario 也有同样问题 → 可能是模拟器问题
3. 如果 Mario 正常 → 可能是 Donkey Kong 特定问题

**优点**: 快速缩小问题范围
**缺点**: 可能需要支持更多游戏特性

### 方向 3: 强制测试渲染功能 🎨

**目标**: 验证 PPU 渲染功能是否正常工作

**行动**:
1. 修改 testbench，在第 100 帧强制设置 PPUMASK = 0x18
2. 观察是否能显示画面
3. 如果能显示 → 说明渲染功能正常，只是初始化问题
4. 如果不能显示 → 说明 PPU 实现有问题

**优点**: 快速验证核心功能
**缺点**: 绕过了真实的初始化流程

## 推荐方案

### 第一步: 测试 Super Mario Bros (5 分钟)
```bash
bash scripts/test_mario.sh
```

**如果 Mario 能正常启动**:
- 说明模拟器基本功能正常
- Donkey Kong 可能有特殊要求
- 可以先完成 Mario 的测试

**如果 Mario 也卡住**:
- 说明可能有通用问题
- 需要检查 NMI 中断
- 需要检查 CPU/PPU 实现

### 第二步: 检查 NMI 中断 (5 分钟)
```bash
bash scripts/monitor_nmi.sh
```

查看是否有 NMI 相关的输出，特别是 PC 是否跳转到 0xc85f

### 第三步: 根据结果决定
- **如果发现问题**: 修复并重新测试
- **如果没有明显问题**: 考虑强制测试渲染功能

## 快速决策树

```
开始
  |
  ├─> 测试 Mario
  |     |
  |     ├─> 正常 → Donkey Kong 特定问题 → 继续用 Mario 测试
  |     └─> 卡住 → 通用问题 → 检查 NMI
  |
  └─> 检查 NMI
        |
        ├─> NMI 正常 → 可能是其他问题 → 强制测试渲染
        └─> NMI 异常 → 修复 NMI → 重新测试
```

## 时间估算

| 任务 | 时间 | 优先级 |
|------|------|--------|
| 测试 Mario | 5 分钟 | 高 |
| 检查 NMI | 5 分钟 | 高 |
| 分析循环代码 | 30 分钟 | 中 |
| 强制测试渲染 | 1 小时 | 中 |
| 深入调试 | 数小时 | 低 |

## 立即执行

建议现在就运行：
```bash
# 快速测试 Mario（2 分钟）
bash scripts/test_mario.sh
```

这将帮助我们快速确定问题的性质。
