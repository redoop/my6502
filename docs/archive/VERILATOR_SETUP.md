# NES Verilator ä»¿çœŸ - å¿«é€Ÿå¼€å§‹

æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•ä½¿ç”¨ Verilator å¯¹ NES æ¨¡æ‹Ÿå™¨è¿›è¡Œç¡¬ä»¶çº§ä»¿çœŸã€‚

## ğŸ¯ ä»€ä¹ˆæ˜¯ Verilator ä»¿çœŸï¼Ÿ

Verilator å°† Chisel ç”Ÿæˆçš„ Verilog ç¡¬ä»¶æè¿°ä»£ç ç¼–è¯‘æˆé«˜æ€§èƒ½çš„ C++ ä»¿çœŸå™¨ï¼Œå¯ä»¥ï¼š

- âœ… **ç¡¬ä»¶çº§ç²¾ç¡®**: å®Œå…¨æ¨¡æ‹ŸçœŸå®ç¡¬ä»¶è¡Œä¸º
- âœ… **é«˜æ€§èƒ½**: æ¯”ä¼ ç»Ÿä»¿çœŸå™¨å¿« 10-100 å€
- âœ… **å¯éªŒè¯**: ç¡®ä¿ä»£ç å¯ä»¥åœ¨ FPGA ä¸Šè¿è¡Œ
- âœ… **å¯è°ƒè¯•**: æŸ¥çœ‹æ‰€æœ‰å†…éƒ¨ä¿¡å·å’ŒçŠ¶æ€

## ğŸ“‹ å‰ç½®è¦æ±‚

### å¿…éœ€è½¯ä»¶

1. **Verilator** (å·²å®‰è£… âœ…)
2. **C++ ç¼–è¯‘å™¨** (å·²å®‰è£… âœ…)
3. **SBT** (å·²å®‰è£… âœ…)

### å¯é€‰è½¯ä»¶

4. **SDL2** - ç”¨äºå›¾å½¢ç•Œé¢ï¼ˆæœªå®‰è£…ï¼Œä½†ä¸å½±å“åŸºæœ¬åŠŸèƒ½ï¼‰

## ğŸš€ å¿«é€Ÿå¼€å§‹ï¼ˆ3 æ­¥ï¼‰

### æ–¹æ³• 1: ä¸€é”®è¿è¡Œï¼ˆæœ€ç®€å•ï¼‰

```bash
# ä½¿ç”¨ç®€åŒ–ç‰ˆï¼ˆæ—  GUIï¼Œæ¨èï¼‰
./run_verilator.sh games/Super-Contra-X-\(China\)-\(Pirate\).nes simple
```

è¿™ä¸ªè„šæœ¬ä¼šè‡ªåŠ¨ï¼š
1. ç”Ÿæˆ Verilogï¼ˆå¦‚æœéœ€è¦ï¼‰
2. ç¼–è¯‘ä»¿çœŸå™¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
3. è¿è¡Œä»¿çœŸ

### æ–¹æ³• 2: åˆ†æ­¥æ‰§è¡Œï¼ˆæ›´çµæ´»ï¼‰

#### æ­¥éª¤ 1: æ£€æŸ¥ç¯å¢ƒ

```bash
./scripts/check_verilator_env.sh
```

#### æ­¥éª¤ 2: ç”Ÿæˆ Verilog

```bash
./scripts/generate_verilog.sh
```

è¿™ä¼šå°† Chisel ä»£ç ç¼–è¯‘æˆ Verilogï¼Œè¾“å‡ºåˆ° `generated/nes/NESSystem.v`

#### æ­¥éª¤ 3: ç¼–è¯‘ä»¿çœŸå™¨

```bash
# ç®€åŒ–ç‰ˆï¼ˆæ¨èï¼Œæ— éœ€ SDL2ï¼‰
./scripts/verilator_build_simple.sh
```

æˆ–è€…å¦‚æœå®‰è£…äº† SDL2ï¼š
```bash
# å®Œæ•´ç‰ˆï¼ˆå¸¦å›¾å½¢ç•Œé¢ï¼‰
./scripts/verilator_build.sh
```

#### æ­¥éª¤ 4: è¿è¡Œä»¿çœŸ

```bash
# ç®€åŒ–ç‰ˆ
./build/verilator_simple/VNESSystem games/Super-Contra-X-\(China\)-\(Pirate\).nes 1000000

# å®Œæ•´ç‰ˆï¼ˆå¦‚æœç¼–è¯‘äº†ï¼‰
./scripts/verilator_run.sh games/Super-Contra-X-\(China\)-\(Pirate\).nes
```

## ğŸ“Š ä»¿çœŸè¾“å‡ºç¤ºä¾‹

### ç®€åŒ–ç‰ˆè¾“å‡º

```
ğŸš€ NES Verilator ç®€åŒ–ä»¿çœŸå™¨
============================
ğŸ”„ å¤ä½ç³»ç»Ÿ...
ğŸ“¦ ROM ä¿¡æ¯:
   PRG ROM: 131072 å­—èŠ‚ (8 x 16KB)
   CHR ROM: 131072 å­—èŠ‚ (16 x 8KB)
   Mapper: 4
â¬†ï¸  åŠ è½½ ROM åˆ°ç¡¬ä»¶...
   PRG: 100%
   CHR: 100%
âœ… ROM åŠ è½½å®Œæˆ
ğŸ® å¼€å§‹ä»¿çœŸ (æœ€å¤š 1000000 å‘¨æœŸ)...
å‘¨æœŸ: 100000 | PC: 0x8234 | A: 0x0 | X: 0x1 | Y: 0x0
ğŸ“º VBlank (å¸§å®Œæˆ)
å‘¨æœŸ: 200000 | PC: 0x8456 | A: 0xff | X: 0x2 | Y: 0x1
...
âœ… ä»¿çœŸå®Œæˆ
   æ€»å‘¨æœŸæ•°: 1000000
```

### è¾“å‡ºè¯´æ˜

- **å‘¨æœŸ**: æ¨¡æ‹Ÿçš„æ—¶é’Ÿå‘¨æœŸæ•°
- **PC**: ç¨‹åºè®¡æ•°å™¨ï¼ˆCPU å½“å‰æ‰§è¡Œä½ç½®ï¼‰
- **A/X/Y**: CPU å¯„å­˜å™¨å€¼
- **VBlank**: å¸§ç»“æŸæ ‡å¿—ï¼ˆæ¯ç§’çº¦ 60 æ¬¡ï¼‰

## ğŸ® ä¸¤ç§ä»¿çœŸæ¨¡å¼

### ç®€åŒ–ç‰ˆ (Simple) - æ¨è

**ä¼˜ç‚¹:**
- âœ… æ— éœ€ SDL2
- âœ… ç¼–è¯‘å¿«é€Ÿ
- âœ… è¿è¡Œé«˜æ•ˆ
- âœ… é€‚åˆè°ƒè¯•å’Œæµ‹è¯•

**ç”¨é€”:**
- éªŒè¯ç¡¬ä»¶é€»è¾‘
- è°ƒè¯• CPU è¡Œä¸º
- æ€§èƒ½æµ‹è¯•
- å¿«é€Ÿè¿­ä»£

**è¿è¡Œ:**
```bash
./build/verilator_simple/VNESSystem <rom> [å‘¨æœŸæ•°]
```

### å®Œæ•´ç‰ˆ (Full) - éœ€è¦ SDL2

**ä¼˜ç‚¹:**
- âœ… å›¾å½¢ç•Œé¢
- âœ… å®æ—¶æ˜¾ç¤º
- âœ… é”®ç›˜æ§åˆ¶
- âœ… å®Œæ•´ä½“éªŒ

**ç”¨é€”:**
- å¯è§†åŒ–éªŒè¯
- æ¸¸æˆæµ‹è¯•
- æ¼”ç¤ºå±•ç¤º

**æ§åˆ¶:**
- æ–¹å‘é”®: ç§»åŠ¨
- Z: A æŒ‰é’®
- X: B æŒ‰é’®
- Enter: Start
- Right Shift: Select

## ğŸ”§ å¸¸è§ä»»åŠ¡

### æµ‹è¯•ä¸åŒçš„ ROM

```bash
./run_verilator.sh games/your-rom.nes simple
```

### è°ƒæ•´ä»¿çœŸå‘¨æœŸ

```bash
# çŸ­æ—¶é—´æµ‹è¯•ï¼ˆ10 ä¸‡å‘¨æœŸï¼‰
./build/verilator_simple/VNESSystem rom.nes 100000

# é•¿æ—¶é—´æµ‹è¯•ï¼ˆ1000 ä¸‡å‘¨æœŸï¼Œçº¦ 5 ç§’ï¼‰
./build/verilator_simple/VNESSystem rom.nes 10000000
```

### é‡æ–°ç”Ÿæˆ Verilog

```bash
# ä¿®æ”¹ Chisel ä»£ç å
./scripts/generate_verilog.sh

# é‡æ–°ç¼–è¯‘ä»¿çœŸå™¨
./scripts/verilator_build_simple.sh
```

### æ¸…ç†æ„å»ºæ–‡ä»¶

```bash
rm -rf build/verilator build/verilator_simple
rm -rf generated/nes
```

## ğŸ“ˆ æ€§èƒ½å‚è€ƒ

| æ¨¡å¼ | ç¼–è¯‘æ—¶é—´ | ä»¿çœŸé€Ÿåº¦ | å†…å­˜å ç”¨ |
|------|----------|----------|----------|
| ç®€åŒ–ç‰ˆ | ~30 ç§’ | 1-5 MHz | ~100 MB |
| å®Œæ•´ç‰ˆ | ~45 ç§’ | 0.5-2 MHz | ~150 MB |

*å®é™… NES CPU é¢‘ç‡: 1.79 MHz*

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜ 1: "verilator: command not found"

**è§£å†³:**
```bash
# Ubuntu/Debian
sudo apt-get install verilator

# macOS
brew install verilator
```

### é—®é¢˜ 2: "Verilog file not found"

**è§£å†³:**
```bash
./scripts/generate_verilog.sh
```

### é—®é¢˜ 3: ç¼–è¯‘å¤±è´¥

**æ£€æŸ¥:**
```bash
# æ£€æŸ¥ C++ ç¼–è¯‘å™¨
g++ --version

# æ£€æŸ¥ Verilator ç‰ˆæœ¬
verilator --version

# é‡æ–°è¿è¡Œç¯å¢ƒæ£€æŸ¥
./scripts/check_verilator_env.sh
```

### é—®é¢˜ 4: ä»¿çœŸé€Ÿåº¦æ…¢

**ä¼˜åŒ–:**
1. ä½¿ç”¨ç®€åŒ–ç‰ˆï¼ˆæ—  GUIï¼‰
2. å‡å°‘ä»¿çœŸå‘¨æœŸæ•°
3. å…³é—­è°ƒè¯•è¾“å‡º
4. ä½¿ç”¨æ›´å¿«çš„ CPU

### é—®é¢˜ 5: ROM åŠ è½½å¤±è´¥

**æ£€æŸ¥:**
1. ROM æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
2. ROM æ˜¯å¦æ˜¯æœ‰æ•ˆçš„ iNES æ ¼å¼
3. æ–‡ä»¶æƒé™æ˜¯å¦æ­£ç¡®

## ğŸ“š æ›´å¤šèµ„æº

### è¯¦ç»†æ–‡æ¡£

- [Verilator ä»¿çœŸæŒ‡å—](docs/VERILATOR_GUIDE.md) - å®Œæ•´æ–‡æ¡£
- [Testbench è¯´æ˜](verilator/README.md) - C++ ä»£ç è¯´æ˜
- [NES æ¶æ„](docs/ARCHITECTURE.md) - ç¡¬ä»¶æ¶æ„

### è„šæœ¬è¯´æ˜

| è„šæœ¬ | åŠŸèƒ½ |
|------|------|
| `run_verilator.sh` | ä¸€é”®è¿è¡Œå®Œæ•´æµç¨‹ |
| `scripts/check_verilator_env.sh` | æ£€æŸ¥ç¯å¢ƒ |
| `scripts/generate_verilog.sh` | ç”Ÿæˆ Verilog |
| `scripts/verilator_build_simple.sh` | ç¼–è¯‘ç®€åŒ–ç‰ˆ |
| `scripts/verilator_build.sh` | ç¼–è¯‘å®Œæ•´ç‰ˆ |
| `scripts/verilator_run.sh` | è¿è¡Œå®Œæ•´ç‰ˆ |

### ç›®å½•ç»“æ„

```
.
â”œâ”€â”€ verilator/              # C++ testbench ä»£ç 
â”‚   â”œâ”€â”€ nes_testbench.cpp          # å®Œæ•´ç‰ˆ
â”‚   â”œâ”€â”€ nes_testbench_simple.cpp   # ç®€åŒ–ç‰ˆ
â”‚   â””â”€â”€ README.md
â”œâ”€â”€ scripts/                # æ„å»ºè„šæœ¬
â”‚   â”œâ”€â”€ check_verilator_env.sh
â”‚   â”œâ”€â”€ generate_verilog.sh
â”‚   â”œâ”€â”€ verilator_build.sh
â”‚   â”œâ”€â”€ verilator_build_simple.sh
â”‚   â””â”€â”€ verilator_run.sh
â”œâ”€â”€ generated/nes/          # ç”Ÿæˆçš„ Verilog
â”‚   â””â”€â”€ NESSystem.v
â”œâ”€â”€ build/                  # ç¼–è¯‘äº§ç‰©
â”‚   â”œâ”€â”€ verilator/          # å®Œæ•´ç‰ˆ
â”‚   â””â”€â”€ verilator_simple/   # ç®€åŒ–ç‰ˆ
â””â”€â”€ docs/
    â””â”€â”€ VERILATOR_GUIDE.md  # è¯¦ç»†æŒ‡å—
```

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **å°è¯•è¿è¡Œ**: ä½¿ç”¨ç°æœ‰ ROM æµ‹è¯•ä»¿çœŸ
2. **ä¿®æ”¹ä»£ç **: æ”¹è¿› Chisel ç¡¬ä»¶è®¾è®¡
3. **ä¼˜åŒ–æ€§èƒ½**: è°ƒæ•´ä»¿çœŸå‚æ•°
4. **å‡†å¤‡ FPGA**: éªŒè¯åå¯éƒ¨ç½²åˆ° FPGA

## ğŸ’¡ æç¤º

- é¦–æ¬¡è¿è¡Œå»ºè®®ä½¿ç”¨ç®€åŒ–ç‰ˆ
- ä»¿çœŸ 100 ä¸‡å‘¨æœŸçº¦éœ€ 1-5 ç§’
- å¯ä»¥éšæ—¶æŒ‰ Ctrl+C åœæ­¢ä»¿çœŸ
- ä¿®æ”¹ Chisel ä»£ç åéœ€é‡æ–°ç”Ÿæˆ Verilog

## â“ éœ€è¦å¸®åŠ©ï¼Ÿ

æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£: `docs/VERILATOR_GUIDE.md`

---

**å‡†å¤‡å¥½äº†å—ï¼Ÿè¿è¡Œä½ çš„ç¬¬ä¸€ä¸ªä»¿çœŸï¼š**

```bash
./run_verilator.sh games/Super-Contra-X-\(China\)-\(Pirate\).nes simple
```
