# ğŸ¨ PPU æ¸²æŸ“ç®¡çº¿è¯¦è§£

## ğŸ“… æ›´æ–°æ—¥æœŸ: 2025-11-27

## ğŸ¯ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº† NES PPU æ¸²æŸ“ç®¡çº¿çš„å®Œæ•´å®ç°ï¼ŒåŒ…æ‹¬èƒŒæ™¯æ¸²æŸ“ã€ç²¾çµæ¸²æŸ“ã€è°ƒè‰²æ¿æŸ¥æ‰¾å’Œå†…å­˜è®¿é—®ä»²è£ã€‚

## ğŸ—ï¸ æ¶æ„

### æ¸²æŸ“ç®¡çº¿ç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  PPURenderPipeline                      â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ BackgroundRendererâ”‚      â”‚ SpriteRenderer   â”‚       â”‚
â”‚  â”‚                  â”‚      â”‚                  â”‚       â”‚
â”‚  â”‚ - Tile Fetch     â”‚      â”‚ - OAM Evaluation â”‚       â”‚
â”‚  â”‚ - Pattern Fetch  â”‚      â”‚ - Sprite Fetch   â”‚       â”‚
â”‚  â”‚ - Attribute      â”‚      â”‚ - Priority       â”‚       â”‚
â”‚  â”‚ - Scrolling      â”‚      â”‚ - Flipping       â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚           â”‚                         â”‚                  â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                      â–¼                                  â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚           â”‚  PaletteLookup   â”‚                         â”‚
â”‚           â”‚                  â”‚                         â”‚
â”‚           â”‚ - Priority Logic â”‚                         â”‚
â”‚           â”‚ - Sprite 0 Hit   â”‚                         â”‚
â”‚           â”‚ - Color Output   â”‚                         â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ ç»„ä»¶è¯¦è§£

### 1. BackgroundRenderer (èƒŒæ™¯æ¸²æŸ“å™¨)

#### åŠŸèƒ½
- æ¸²æŸ“èƒŒæ™¯ tiles
- å¤„ç†æ»šåŠ¨
- æ”¯æŒå±æ€§è¡¨
- Pattern table é€‰æ‹©

#### æ¸²æŸ“æµç¨‹

```
1. Fetch Nametable
   â”œâ”€ è®¡ç®— tile åæ ‡ (tileX, tileY)
   â”œâ”€ é€‰æ‹© nametable (æ”¯æŒ 4 ä¸ª nametable)
   â””â”€ è¯»å– tile ç´¢å¼•

2. Fetch Attribute
   â”œâ”€ è®¡ç®—å±æ€§è¡¨åœ°å€
   â”œâ”€ è¯»å–å±æ€§å­—èŠ‚
   â””â”€ æå–è°ƒè‰²æ¿é€‰æ‹© (2 bits)

3. Fetch Pattern Low
   â”œâ”€ è®¡ç®— pattern åœ°å€
   â”œâ”€ é€‰æ‹© pattern table (PPUCTRL bit 4)
   â””â”€ è¯»å–ä½ä½å¹³é¢

4. Fetch Pattern High
   â”œâ”€ è¯»å–é«˜ä½å¹³é¢ (+8 å­—èŠ‚)
   â””â”€ åŠ è½½åˆ°ç§»ä½å¯„å­˜å™¨

5. Render
   â”œâ”€ ä»ç§»ä½å¯„å­˜å™¨æå–åƒç´ 
   â”œâ”€ ç»„åˆ 2 ä½é¢œè‰²ç´¢å¼•
   â””â”€ è¾“å‡ºè°ƒè‰²æ¿ç´¢å¼•å’Œé€‰æ‹©
```

#### å…³é”®ç‰¹æ€§

**æ»šåŠ¨æ”¯æŒ**
```scala
val scrolledX = pixelX + scrollX
val scrolledY = pixelY + scrollY
val tileX = scrolledX >> 3  // é™¤ä»¥ 8
val tileY = scrolledY >> 3
```

**Nametable é€‰æ‹©**
```scala
val nametableSelect = Cat(scrolledY(8), scrolledX(8))
// 00 = $2000, 01 = $2400, 10 = $2800, 11 = $2C00
```

**å±æ€§è¡¨è§£ç **
```scala
// å±æ€§å­—èŠ‚æ ¼å¼: [å³ä¸‹][å·¦ä¸‹][å³ä¸Š][å·¦ä¸Š]
val quadrantX = tileX(1)
val quadrantY = tileY(1)
val attrShift = Cat(quadrantY, quadrantX) << 1
val paletteSelect = (attributeByte >> attrShift)(1, 0)
```

### 2. SpriteRenderer (ç²¾çµæ¸²æŸ“å™¨)

#### åŠŸèƒ½
- OAM è¯„ä¼°
- ç²¾çµæ¸²æŸ“
- ç²¾çµç¿»è½¬
- ç²¾çµ 0 ç¢°æ’æ£€æµ‹
- ä¼˜å…ˆçº§å¤„ç†

#### ç²¾çµè¯„ä¼°æµç¨‹

```
æ‰«æçº¿ 256-320: ç²¾çµè¯„ä¼°
â”œâ”€ 1. æ¸…ç©ºæ¬¡çº§ OAM
â”œâ”€ 2. æ‰«æ 64 ä¸ªç²¾çµ
â”‚   â”œâ”€ è¯»å– Y åæ ‡
â”‚   â”œâ”€ æ£€æŸ¥æ˜¯å¦åœ¨ä¸‹ä¸€æ¡æ‰«æçº¿
â”‚   â””â”€ æ·»åŠ åˆ°æ¬¡çº§ OAM (æœ€å¤š 8 ä¸ª)
â”œâ”€ 3. é¢„å–ç²¾çµ pattern æ•°æ®
â”‚   â”œâ”€ è®¡ç®— pattern åœ°å€
â”‚   â”œâ”€ å¤„ç†å‚ç›´ç¿»è½¬
â”‚   â””â”€ è¯»å–ä½ä½å’Œé«˜ä½å¹³é¢
â””â”€ 4. å‡†å¤‡æ¸²æŸ“
```

#### ç²¾çµæ•°æ®ç»“æ„

```scala
class SpriteData extends Bundle {
  val y = UInt(8.W)           // Y åæ ‡
  val tileIndex = UInt(8.W)   // Tile ç´¢å¼•
  val attributes = UInt(8.W)  // å±æ€§
  val x = UInt(8.W)           // X åæ ‡
  val patternLow = UInt(8.W)  // Pattern ä½ä½
  val patternHigh = UInt(8.W) // Pattern é«˜ä½
  val isSprite0 = Bool()      // æ˜¯å¦ä¸ºç²¾çµ 0
}
```

#### ç²¾çµå±æ€§

```
Bit 7-6: æœªä½¿ç”¨
Bit 5:   ä¼˜å…ˆçº§ (0=å‰æ™¯, 1=èƒŒæ™¯åé¢)
Bit 4-2: æœªä½¿ç”¨
Bit 1-0: è°ƒè‰²æ¿é€‰æ‹© (0-3)
```

#### ç¿»è½¬å¤„ç†

**å‚ç›´ç¿»è½¬**
```scala
val actualY = Mux(attributes(7), 
  spriteHeight - 1.U - spriteY,
  spriteY
)
```

**æ°´å¹³ç¿»è½¬**
```scala
val actualX = Mux(attributes(6), 
  7.U - spriteX,
  spriteX
)
```

#### ç²¾çµ 0 ç¢°æ’

ç²¾çµ 0 ç¢°æ’åœ¨ä»¥ä¸‹æ¡ä»¶ä¸‹å‘ç”Ÿï¼š
1. ç²¾çµ 0 çš„åƒç´ ä¸é€æ˜ (é 0)
2. èƒŒæ™¯åƒç´ ä¸é€æ˜ (é 0)
3. åƒç´ ä½ç½®é‡å 

```scala
io.sprite0Hit := sprite.isSprite0 && pixel =/= 0.U
```

### 3. PaletteLookup (è°ƒè‰²æ¿æŸ¥æ‰¾)

#### åŠŸèƒ½
- èƒŒæ™¯/ç²¾çµä¼˜å…ˆçº§
- è°ƒè‰²æ¿åœ°å€è®¡ç®—
- ç²¾çµ 0 ç¢°æ’æ£€æµ‹
- é¢œè‰²è¾“å‡º

#### ä¼˜å…ˆçº§é€»è¾‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   èƒŒæ™¯      â”‚   ç²¾çµ      â”‚   ç»“æœ       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é€æ˜ (0)    â”‚ é€æ˜ (0)    â”‚ èƒŒæ™¯è‰²       â”‚
â”‚ é€æ˜ (0)    â”‚ ä¸é€æ˜      â”‚ ç²¾çµ         â”‚
â”‚ ä¸é€æ˜      â”‚ é€æ˜ (0)    â”‚ èƒŒæ™¯         â”‚
â”‚ ä¸é€æ˜      â”‚ ä¸é€æ˜      â”‚ çœ‹ä¼˜å…ˆçº§     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### è°ƒè‰²æ¿åœ°å€è®¡ç®—

**èƒŒæ™¯è°ƒè‰²æ¿**
```
åœ°å€ = $3F00 + paletteSelect * 4 + paletteIndex
èŒƒå›´: $3F00-$3F0F
```

**ç²¾çµè°ƒè‰²æ¿**
```
åœ°å€ = $3F10 + paletteSelect * 4 + paletteIndex
èŒƒå›´: $3F10-$3F1F
```

**èƒŒæ™¯è‰² (Universal Background)**
```
åœ°å€ = $3F00
ç”¨äºèƒŒæ™¯å’Œç²¾çµéƒ½é€æ˜çš„æƒ…å†µ
```

### 4. PPURenderPipeline (å®Œæ•´æ¸²æŸ“ç®¡çº¿)

#### åŠŸèƒ½
- é›†æˆæ‰€æœ‰æ¸²æŸ“ç»„ä»¶
- å†…å­˜è®¿é—®ä»²è£
- æ¸²æŸ“ä½¿èƒ½æ§åˆ¶
- å·¦ä¾§è£å‰ª

#### å†…å­˜è®¿é—®ä»²è£

ä½¿ç”¨æ—¶åˆ†å¤ç”¨ç­–ç•¥ï¼Œæ¯ä¸ªå‘¨æœŸè®¿é—®ä¸åŒçš„å†…å­˜ï¼š

```
å‘¨æœŸ 0: èƒŒæ™¯ VRAM è®¿é—® (Nametable/Attribute)
å‘¨æœŸ 1: èƒŒæ™¯ Pattern è®¿é—®
å‘¨æœŸ 2: ç²¾çµ OAM è®¿é—®
å‘¨æœŸ 3: ç²¾çµ Pattern è®¿é—®
```

#### PPUMASK æ§åˆ¶

```
Bit 4: æ˜¾ç¤ºç²¾çµ
Bit 3: æ˜¾ç¤ºèƒŒæ™¯
Bit 2: æ˜¾ç¤ºæœ€å·¦ 8 åƒç´ çš„ç²¾çµ
Bit 1: æ˜¾ç¤ºæœ€å·¦ 8 åƒç´ çš„èƒŒæ™¯
```

#### å·¦ä¾§è£å‰ª

```scala
val showBg = showBackground && (showBgLeft || pixelX >= 8.U)
val showSpr = showSprites && (showSpritesLeft || pixelX >= 8.U)
```

## ğŸ¨ æ¸²æŸ“ç¤ºä¾‹

### ç®€å•èƒŒæ™¯æ¸²æŸ“

```scala
// 1. è®¾ç½® PPUCTRL
ppuCtrl = 0x00  // Pattern table 0, nametable 0

// 2. è®¾ç½® PPUMASK
ppuMask = 0x08  // æ˜¾ç¤ºèƒŒæ™¯

// 3. å†™å…¥ nametable
for (y <- 0 until 30) {
  for (x <- 0 until 32) {
    vram(y * 32 + x) = tileIndex
  }
}

// 4. å†™å…¥å±æ€§è¡¨
for (i <- 0 until 64) {
  vram(0x3C0 + i) = 0x00  // å…¨éƒ¨ä½¿ç”¨è°ƒè‰²æ¿ 0
}

// 5. è®¾ç½®è°ƒè‰²æ¿
palette(0) = 0x0F  // èƒŒæ™¯è‰² (é»‘è‰²)
palette(1) = 0x30  // é¢œè‰² 1 (ç™½è‰²)
palette(2) = 0x16  // é¢œè‰² 2 (çº¢è‰²)
palette(3) = 0x27  // é¢œè‰² 3 (ç»¿è‰²)
```

### ç²¾çµæ¸²æŸ“

```scala
// 1. è®¾ç½® PPUCTRL
ppuCtrl = 0x08  // Pattern table 1 for sprites

// 2. è®¾ç½® PPUMASK
ppuMask = 0x10  // æ˜¾ç¤ºç²¾çµ

// 3. å†™å…¥ OAM
oam(0) = 100  // Y åæ ‡
oam(1) = 0x42 // Tile ç´¢å¼•
oam(2) = 0x00 // å±æ€§ (è°ƒè‰²æ¿ 0, å‰æ™¯)
oam(3) = 120  // X åæ ‡

// 4. è®¾ç½®ç²¾çµè°ƒè‰²æ¿
palette(0x11) = 0x30  // ç²¾çµè°ƒè‰²æ¿ 0, é¢œè‰² 1
palette(0x12) = 0x16  // ç²¾çµè°ƒè‰²æ¿ 0, é¢œè‰² 2
palette(0x13) = 0x27  // ç²¾çµè°ƒè‰²æ¿ 0, é¢œè‰² 3
```

## ğŸ”§ æ€§èƒ½ä¼˜åŒ–

### 1. æµæ°´çº¿ä¼˜åŒ–

- é¢„å–ä¸‹ä¸€ä¸ª tile çš„æ•°æ®
- ä½¿ç”¨ç§»ä½å¯„å­˜å™¨å‡å°‘å†…å­˜è®¿é—®
- å¹¶è¡Œå¤„ç†èƒŒæ™¯å’Œç²¾çµ

### 2. å†…å­˜è®¿é—®ä¼˜åŒ–

- æ—¶åˆ†å¤ç”¨å‡å°‘å†²çª
- ç¼“å­˜å¸¸ç”¨æ•°æ®
- æ‰¹é‡è¯»å– pattern æ•°æ®

### 3. ç²¾çµè¯„ä¼°ä¼˜åŒ–

- åœ¨æ‰«æçº¿ç»“æŸæ—¶è¯„ä¼°
- åªè¯„ä¼°å¯è§ç²¾çµ
- é™åˆ¶ä¸º 8 ä¸ªç²¾çµ/æ‰«æçº¿

## ğŸ§ª æµ‹è¯•

### æµ‹è¯•ç”¨ä¾‹

1. **èƒŒæ™¯æ¸²æŸ“æµ‹è¯•**
   - Tile åæ ‡è®¡ç®—
   - æ»šåŠ¨å¤„ç†
   - Pattern table é€‰æ‹©
   - å±æ€§è¡¨è§£ç 

2. **ç²¾çµæ¸²æŸ“æµ‹è¯•**
   - OAM è¯„ä¼°
   - ç²¾çµç¿»è½¬
   - ç²¾çµ 0 ç¢°æ’
   - ä¼˜å…ˆçº§å¤„ç†

3. **è°ƒè‰²æ¿æµ‹è¯•**
   - èƒŒæ™¯è°ƒè‰²æ¿é€‰æ‹©
   - ç²¾çµè°ƒè‰²æ¿é€‰æ‹©
   - ä¼˜å…ˆçº§é€»è¾‘
   - ç¢°æ’æ£€æµ‹

4. **é›†æˆæµ‹è¯•**
   - å®Œæ•´æ¸²æŸ“ç®¡çº¿
   - å†…å­˜è®¿é—®ä»²è£
   - å·¦ä¾§è£å‰ª
   - å¤šå‘¨æœŸè¿è¡Œ

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æ¸²æŸ“å™¨æµ‹è¯•
sbt "testOnly nes.PPURendererTest"

# è¿è¡Œç‰¹å®šæµ‹è¯•
sbt "testOnly nes.PPURendererTest -- -z BackgroundRenderer"
sbt "testOnly nes.PPURendererTest -- -z SpriteRenderer"
sbt "testOnly nes.PPURendererTest -- -z PaletteLookup"
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### èµ„æºä½¿ç”¨

| ç»„ä»¶ | LUTs | FFs | BRAM |
|------|------|-----|------|
| BackgroundRenderer | ~500 | ~200 | 0 |
| SpriteRenderer | ~800 | ~400 | 0 |
| PaletteLookup | ~100 | ~50 | 0 |
| PPURenderPipeline | ~1500 | ~700 | 0 |

### æ—¶åº

| æ“ä½œ | å‘¨æœŸæ•° |
|------|--------|
| Tile æ¸²æŸ“ | 4 |
| ç²¾çµè¯„ä¼° | 64 |
| ç²¾çµé¢„å– | 8 |
| åƒç´ è¾“å‡º | 1 |

## ğŸ¯ ä¸‹ä¸€æ­¥

### çŸ­æœŸç›®æ ‡

1. âœ… å®Œå–„èƒŒæ™¯æ¸²æŸ“
2. âœ… å®ç°ç²¾çµæ¸²æŸ“
3. âœ… æ·»åŠ è°ƒè‰²æ¿æŸ¥æ‰¾
4. âœ… é›†æˆæ¸²æŸ“ç®¡çº¿
5. ğŸš§ é›†æˆåˆ° PPUv2
6. â³ å®é™…æ¸¸æˆæµ‹è¯•

### ä¸­æœŸç›®æ ‡

1. â³ ä¼˜åŒ–å†…å­˜è®¿é—®
2. â³ æ·»åŠ  8x16 ç²¾çµæ”¯æŒ
3. â³ å®ç°ç²¾çµæº¢å‡ºæ£€æµ‹
4. â³ ä¼˜åŒ–æµæ°´çº¿æ€§èƒ½

### é•¿æœŸç›®æ ‡

1. â³ å®Œæ•´çš„ NES å…¼å®¹æ€§
2. â³ é«˜çº§æ¸²æŸ“ç‰¹æ•ˆ
3. â³ ç¡¬ä»¶åŠ é€Ÿ
4. â³ FPGA å®ç°

## ğŸ“š å‚è€ƒèµ„æ–™

### NES PPU æ–‡æ¡£
- [NesDev PPU](https://www.nesdev.org/wiki/PPU)
- [PPU Rendering](https://www.nesdev.org/wiki/PPU_rendering)
- [PPU Scrolling](https://www.nesdev.org/wiki/PPU_scrolling)
- [PPU Palettes](https://www.nesdev.org/wiki/PPU_palettes)

### ç²¾çµç³»ç»Ÿ
- [PPU OAM](https://www.nesdev.org/wiki/PPU_OAM)
- [PPU Sprite Evaluation](https://www.nesdev.org/wiki/PPU_sprite_evaluation)
- [Sprite 0 Hit](https://www.nesdev.org/wiki/PPU_OAM#Sprite_0_hits)

### Pattern Tables
- [PPU Pattern Tables](https://www.nesdev.org/wiki/PPU_pattern_tables)
- [CHR ROM/RAM](https://www.nesdev.org/wiki/CHR_ROM)

## ğŸ’¡ æŠ€å·§å’Œæœ€ä½³å®è·µ

### èƒŒæ™¯æ¸²æŸ“

1. **é¢„å–æ•°æ®** - åœ¨æ¸²æŸ“å‰é¢„å–ä¸‹ä¸€ä¸ª tile
2. **ä½¿ç”¨ç§»ä½å¯„å­˜å™¨** - å‡å°‘å†…å­˜è®¿é—®
3. **ç¼“å­˜å±æ€§** - å±æ€§è¡¨è®¿é—®è¾ƒæ…¢

### ç²¾çµæ¸²æŸ“

1. **æ—©æœŸè¯„ä¼°** - åœ¨æ‰«æçº¿ç»“æŸæ—¶è¯„ä¼°
2. **é™åˆ¶æ•°é‡** - æ¯æ¡æ‰«æçº¿æœ€å¤š 8 ä¸ªç²¾çµ
3. **ä¼˜å…ˆçº§æ’åº** - æŒ‰ OAM é¡ºåºæ¸²æŸ“

### è°ƒè‰²æ¿

1. **ç¼“å­˜æŸ¥æ‰¾** - è°ƒè‰²æ¿è®¿é—®é¢‘ç¹
2. **å¤„ç†é•œåƒ** - æ­£ç¡®å¤„ç† $3F10/$3F14/$3F18/$3F1C
3. **èƒŒæ™¯è‰²** - é€æ˜åƒç´ ä½¿ç”¨ $3F00

### æ€§èƒ½

1. **æµæ°´çº¿** - å¹¶è¡Œå¤„ç†å¤šä¸ªé˜¶æ®µ
2. **æ—¶åˆ†å¤ç”¨** - å…±äº«å†…å­˜è®¿é—®
3. **å‡å°‘å»¶è¿Ÿ** - æœ€å°åŒ–å…³é”®è·¯å¾„

---

**ç‰ˆæœ¬**: v1.0
**ä½œè€…**: NES å¼€å‘å›¢é˜Ÿ
**æœ€åæ›´æ–°**: 2025-11-27
