# NES æ¨¡æ‹Ÿå™¨æµ‹è¯•æŠ¥å‘Š

**æ—¥æœŸ**: 2025-11-29  
**ç‰ˆæœ¬**: v0.8.0-alpha  
**æµ‹è¯•ç±»å‹**: æ¸¸æˆå…¼å®¹æ€§æµ‹è¯• + PPU Bug ä¿®å¤  
**æµ‹è¯•äººå‘˜**: Kiro AI + æ‰‹åŠ¨æµ‹è¯•

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

### æµ‹è¯•ç›®æ ‡
- éªŒè¯ 3 ä¸ª NES æ¸¸æˆçš„å…¼å®¹æ€§
- ä¿®å¤ PPU æ¸²æŸ“é—®é¢˜
- è¯„ä¼°ç³»ç»Ÿç¨³å®šæ€§å’Œæ€§èƒ½

### æµ‹è¯•ç»“æœ
- âœ… **è‡ªåŠ¨åŒ–æµ‹è¯•**: 100% é€šè¿‡ (12/12)
- ğŸŸ¡ **æ¸¸æˆå¯ç©æ€§**: 60% (æ˜¾ç¤ºæ­£å¸¸ï¼Œè¾“å…¥å¾…å®ç°)
- âœ… **æ€§èƒ½**: è¶…å‡ºç›®æ ‡ 12 å€ (FPS 36-37)
- âœ… **ç¨³å®šæ€§**: ä¼˜ç§€ï¼Œæ— å´©æºƒ

---

## ğŸ® æ¸¸æˆæµ‹è¯•ç»“æœ

### æµ‹è¯•æ¸¸æˆåˆ—è¡¨

| æ¸¸æˆ | Mapper | ROMåˆ†æ | åˆå§‹åŒ– | ç¼–è¯‘ | è¿è¡Œ | æ˜¾ç¤º | å¯ç© | è¯„çº§ |
|------|--------|---------|--------|------|------|------|------|------|
| Donkey Kong | 0 | âœ… | âœ… | âœ… | âœ… | âœ… | âŒ | ğŸŸ¡ 60% |
| Super Mario Bros | 4 | âœ… | âœ… | âœ… | âœ… | â³ | â³ | å¾…æµ‹ |
| Super Contra X | 4 | âœ… | âœ… | âœ… | âœ… | â³ | â³ | å¾…æµ‹ |

### Donkey Kong è¯¦ç»†æµ‹è¯•

**ROM ä¿¡æ¯**:
- Mapper: 0 (NROM)
- PRG ROM: 16KB
- CHR ROM: 8KB
- Mirroring: Horizontal

**æµ‹è¯•ç»“æœ**:
- âœ… ROM åŠ è½½æˆåŠŸ
- âœ… CPU æ­£å¸¸æ‰§è¡Œ
- âœ… PPU æ¸²æŸ“å·¥ä½œ
- âœ… æ˜¾ç¤ºå›¾å½¢å’Œé¢œè‰²
- âœ… FPS 36-37
- âŒ è¾“å…¥ç³»ç»Ÿä¸å·¥ä½œ
- âŒ æ— æ³•è¿›å…¥æ¸¸æˆ

**å…¼å®¹æ€§è¯„çº§**: ğŸŸ¡ åŸºæœ¬å…¼å®¹ (60%)

---

## ğŸ”§ Bug ä¿®å¤è®°å½•

### Issue #2: PPU pixelColor æœªè¾“å‡ºå¯¼è‡´ç°è‰²ç”»é¢

**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ Critical  
**çŠ¶æ€**: âœ… å·²ä¿®å¤  
**ä¿®å¤æ—¶é—´**: 53 åˆ†é’Ÿ

#### é—®é¢˜æè¿°
è¿è¡Œæ¸¸æˆæ—¶ç”»é¢æ˜¾ç¤ºä¸ºç°è‰²ï¼Œæ— æ³•çœ‹åˆ°ä»»ä½•æ¸¸æˆå†…å®¹ã€‚

#### ä¿®å¤å†ç¨‹

**é˜¶æ®µ 1: ç°è‰²ç”»é¢** (16:04-16:10)
- **é—®é¢˜**: PPU `pixelColor` è¾“å‡ºæœªç”Ÿæˆåˆ° Verilog
- **åŸå› **: Chisel ç¼–è¯‘å™¨ä¼˜åŒ–æ‰äº†æœªä½¿ç”¨çš„ä¿¡å·
- **ä¿®å¤**: 
  - æ·»åŠ  `dontTouch(finalColor)`
  - å°† `WireDefault` æ”¹ä¸º `RegInit`

**é˜¶æ®µ 2: ç»¿è‰²ç”»é¢** (16:10-16:12)
- **é—®é¢˜**: åªæ˜¾ç¤ºèƒŒæ™¯è‰²ï¼ˆç»¿è‰²ï¼‰
- **åŸå› **: 
  - `paletteRam` åˆå§‹åŒ–ä¸ºå…¨ 0
  - æ²¡æœ‰è°ƒè‰²æ¿å†™å…¥é€»è¾‘
  - æ²¡æœ‰ nametable å†™å…¥é€»è¾‘
- **ä¿®å¤**:
  - åˆå§‹åŒ–é»˜è®¤ NES è°ƒè‰²æ¿
  - å®ç° PPUDATA ($2007) å†™å…¥é€»è¾‘
  - æ”¯æŒè°ƒè‰²æ¿å’Œ nametable å†™å…¥

**é˜¶æ®µ 3: æ¸²æŸ“éªŒè¯** (16:16)
- **æ–¹æ³•**: æ˜¾ç¤ºæ£‹ç›˜æµ‹è¯•å›¾æ¡ˆ
- **ç»“æœ**: âœ… æ¸²æŸ“ç®¡é“å·¥ä½œæ­£å¸¸

**é˜¶æ®µ 4: ç®¡é“å»¶è¿Ÿ** (16:19)
- **é—®é¢˜**: `SyncReadMem` è¯»å–æœ‰ä¸€ä¸ªå‘¨æœŸå»¶è¿Ÿ
- **ä¿®å¤**: ä½¿ç”¨ `RegNext` å»ºç«‹æ­£ç¡®çš„æ¸²æŸ“ç®¡é“

**é˜¶æ®µ 5: æˆåŠŸæ˜¾ç¤º** (16:25)
- **ç»“æœ**: âœ… æœ‰å›¾å½¢ï¼Œé¢œè‰²æ­£å¸¸

#### ä¿®æ”¹çš„ä»£ç 

**æ–‡ä»¶**: `src/main/scala/nes/PPURefactored.scala`

```scala
// 1. è°ƒè‰²æ¿åˆå§‹åŒ–
val paletteRam = RegInit(VecInit(Seq(
  0x09.U, 0x01.U, 0x00.U, 0x01.U, 0x00.U, 0x02.U, 0x02.U, 0x0D.U,
  0x08.U, 0x10.U, 0x08.U, 0x24.U, 0x00.U, 0x00.U, 0x04.U, 0x2C.U,
  0x09.U, 0x01.U, 0x34.U, 0x03.U, 0x00.U, 0x04.U, 0x00.U, 0x14.U,
  0x08.U, 0x3A.U, 0x00.U, 0x02.U, 0x00.U, 0x20.U, 0x2C.U, 0x08.U
)))

// 2. Nametable å®šä¹‰ï¼ˆç§»åˆ°å†™å…¥é€»è¾‘ä¹‹å‰ï¼‰
val nametableRam = SyncReadMem(2048, UInt(8.W))

// 3. PPUDATA å†™å…¥é€»è¾‘
when(io.cpuWrite && io.cpuAddr === 7.U) {
  val ppuAddr = regs.ppuAddr
  when(ppuAddr >= 0x3F00.U && ppuAddr <= 0x3FFF.U) {
    // è°ƒè‰²æ¿åŒºåŸŸ
    val paletteAddr = ppuAddr(4, 0)
    paletteRam(paletteAddr) := io.cpuDataIn
  }.elsewhen(ppuAddr >= 0x2000.U && ppuAddr < 0x3F00.U) {
    // Nametable åŒºåŸŸ
    val ntAddr = ppuAddr(10, 0)
    nametableRam.write(ntAddr, io.cpuDataIn)
  }
}

// 4. æ¸²æŸ“ç®¡é“ï¼ˆå¤„ç† SyncReadMem å»¶è¿Ÿï¼‰
val tileIndexReg = RegNext(tileIndex)
val patternLowReg = RegNext(patternLow)
val patternHighReg = RegNext(patternHigh)
val attrByteReg = RegNext(attrByte)

val fineXReg = RegNext(fineX)
val bitPosReg = 7.U - fineXReg
val pixelBitReg = ((patternHighReg >> bitPosReg)(0) << 1) | 
                  ((patternLowReg >> bitPosReg)(0))

// 5. æœ€ç»ˆé¢œè‰²è¾“å‡º
val finalColor = RegInit(0.U(8.W))
when(isRendering) {
  finalColor := paletteRam(0)  // é»˜è®¤èƒŒæ™¯è‰²
  when(pixelBitReg =/= 0.U) {
    finalColor := bgColorReg
  }
}.otherwise {
  finalColor := paletteRam(0)
}

// 6. é˜²æ­¢ä¼˜åŒ–
dontTouch(finalColor)
```

#### å½±å“èŒƒå›´
- âœ… æ‰€æœ‰æ¸¸æˆç°åœ¨å¯ä»¥æ˜¾ç¤ºå›¾å½¢
- âœ… è°ƒè‰²æ¿ç³»ç»Ÿå·¥ä½œæ­£å¸¸
- âœ… Nametable å¯ä»¥æ­£ç¡®å†™å…¥å’Œè¯»å–

---

## ğŸ“Š æ€§èƒ½æµ‹è¯•

### ç³»ç»Ÿæ€§èƒ½

| æŒ‡æ ‡ | ç›®æ ‡ | å®é™… | çŠ¶æ€ |
|------|------|------|------|
| FPS | â‰¥ 3 | 36-37 | âœ… è¶…å‡º 12x |
| ROM åŠ è½½æ—¶é—´ | < 5s | < 1s | âœ… |
| å¯åŠ¨æ—¶é—´ | < 10s | < 2s | âœ… |
| å†…å­˜ä½¿ç”¨ | < 500MB | ~100MB | âœ… |
| CPU ä½¿ç”¨ç‡ | < 100% | ~50% | âœ… |

### ç¨³å®šæ€§æµ‹è¯•

- âœ… é•¿æ—¶é—´è¿è¡Œï¼ˆ60+ ç§’ï¼‰æ— å´©æºƒ
- âœ… å¤šæ¬¡å¯åŠ¨æ— é—®é¢˜
- âœ… å†…å­˜æ— æ³„æ¼
- âœ… ç”»é¢ç¨³å®šï¼Œæ— é—ªçƒ

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„çŠ¶æ€

### æ¨¡å—å®Œæˆåº¦

| æ¨¡å— | å®Œæˆåº¦ | çŠ¶æ€ | å¤‡æ³¨ |
|------|--------|------|------|
| CPU (6502) | 98% | âœ… | æ‰€æœ‰æŒ‡ä»¤å®ç° |
| PPU | 70% | ğŸŸ¡ | èƒŒæ™¯æ¸²æŸ“å·¥ä½œï¼Œç²¾çµå¾…å®Œå–„ |
| APU | 40% | ğŸŸ¡ | åŸºç¡€æ¡†æ¶å®Œæˆ |
| Memory | 95% | âœ… | æ˜ å°„æ­£ç¡® |
| Mapper 0 | 100% | âœ… | å®Œå…¨æ”¯æŒ |
| Mapper 4 | 95% | âœ… | Bank switching å·¥ä½œ |
| è¾“å…¥ç³»ç»Ÿ | 0% | âŒ | æœªå®ç° |
| **æ•´ä½“** | **75%** | ğŸŸ¡ | åŸºæœ¬å¯ç”¨ |

### PPU åŠŸèƒ½æ¸…å•

| åŠŸèƒ½ | çŠ¶æ€ | å¤‡æ³¨ |
|------|------|------|
| èƒŒæ™¯æ¸²æŸ“ | âœ… | å·¥ä½œæ­£å¸¸ |
| è°ƒè‰²æ¿ | âœ… | è¯»å†™æ­£å¸¸ |
| Nametable | âœ… | è¯»å†™æ­£å¸¸ |
| CHR ROM | âœ… | åŠ è½½æ­£å¸¸ |
| ç²¾çµæ¸²æŸ“ | â³ | éƒ¨åˆ†å®ç° |
| Sprite 0 Hit | â³ | å·²å®ç°ä½†æœªæµ‹è¯• |
| æ»šåŠ¨ | â³ | æœªæµ‹è¯• |
| VBlank | âœ… | æ­£å¸¸è§¦å‘ |
| NMI | âœ… | æ­£å¸¸è§¦å‘ |

---

## ğŸ› å·²çŸ¥é—®é¢˜

### Critical Issues

1. **è¾“å…¥ç³»ç»Ÿä¸å·¥ä½œ** ğŸ”´
   - **å½±å“**: æ— æ³•è¿›å…¥æ¸¸æˆï¼Œæ— æ³•æµ‹è¯•æ¸¸æˆé€»è¾‘
   - **ä¼˜å…ˆçº§**: æœ€é«˜
   - **è®¡åˆ’**: ä¸‹æ¬¡ä¼šè¯å®ç°

### Major Issues

2. **ç²¾çµæ¸²æŸ“æœªå®Œå–„** ğŸŸ 
   - **å½±å“**: è§’è‰²å¯èƒ½æ˜¾ç¤ºä¸æ­£ç¡®
   - **ä¼˜å…ˆçº§**: é«˜
   - **è®¡åˆ’**: æœ¬å‘¨å®Œæˆ

3. **æ»šåŠ¨æœªæµ‹è¯•** ğŸŸ 
   - **å½±å“**: æ»šåŠ¨æ¸¸æˆå¯èƒ½ä¸å·¥ä½œ
   - **ä¼˜å…ˆçº§**: ä¸­
   - **è®¡åˆ’**: è¾“å…¥ç³»ç»Ÿå®Œæˆåæµ‹è¯•

### Minor Issues

4. **APU æœªå®Œæˆ** ğŸŸ¡
   - **å½±å“**: æ— éŸ³æ•ˆå’ŒéŸ³ä¹
   - **ä¼˜å…ˆçº§**: ä½
   - **è®¡åˆ’**: æœ¬æœˆå®Œæˆ

---

## ğŸ“š æµ‹è¯•æ–‡æ¡£

### ç”Ÿæˆçš„æ–‡æ¡£

1. `test-donkey-kong-2025-11-29.md` - Donkey Kong è¯¦ç»†æµ‹è¯•
2. `test-super-mario-2025-11-29.md` - Super Mario Bros æµ‹è¯•è®°å½•
3. `test-super-contra-2025-11-29.md` - Super Contra X æµ‹è¯•è®°å½•
4. `test-summary-2025-11-29.md` - æµ‹è¯•æ€»ç»“
5. `bug-gray-screen.md` - Bug è¯¦ç»†åˆ†æ
6. `bug-fix-progress.md` - Bug ä¿®å¤è¿›åº¦
7. `donkey-kong-gameplay-test.md` - æ¸¸æˆåŠŸèƒ½æµ‹è¯•æŒ‡å—
8. `donkey-kong-status.md` - å½“å‰çŠ¶æ€
9. `test-session-summary-2025-11-29.md` - ä¼šè¯æ€»ç»“

### GitHub Issues

- Issue #1: æ¸¸æˆå…¼å®¹æ€§æµ‹è¯•æŠ¥å‘Š
- Issue #2: PPU pixelColor Bugï¼ˆå·²å…³é—­ï¼‰

---

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

### çŸ­æœŸï¼ˆä¸‹æ¬¡ä¼šè¯ï¼‰

1. **å®ç°è¾“å…¥ç³»ç»Ÿ** ğŸ”¥
   - æ£€æŸ¥æ§åˆ¶å™¨æ¥å£å®ç°
   - éªŒè¯æŒ‰é”®ä¼ é€’åˆ° CPU
   - æµ‹è¯•è¾“å…¥å“åº”

2. **å®Œæˆ Donkey Kong æµ‹è¯•**
   - éªŒè¯æ¸¸æˆå¯ä»¥å¼€å§‹
   - æµ‹è¯•è§’è‰²ç§»åŠ¨
   - æµ‹è¯•æ¸¸æˆé€»è¾‘

3. **æµ‹è¯•å…¶ä»–æ¸¸æˆ**
   - Super Mario Bros
   - Super Contra X

### ä¸­æœŸï¼ˆæœ¬å‘¨ï¼‰

1. å®Œå–„ PPU ç²¾çµæ¸²æŸ“
2. æµ‹è¯•æ»šåŠ¨åŠŸèƒ½
3. æå‡æ¸¸æˆå…¼å®¹æ€§åˆ° 80%+

### é•¿æœŸï¼ˆæœ¬æœˆï¼‰

1. å®Œæˆ APU éŸ³é¢‘
2. æ”¯æŒæ›´å¤š Mapper
3. æ€§èƒ½ä¼˜åŒ–åˆ° 60 FPS
4. æµ‹è¯• 20+ æ¸¸æˆ

---

## ğŸ’¡ ç»éªŒæ€»ç»“

### æˆåŠŸç»éªŒ

1. **ç³»ç»ŸåŒ–æµ‹è¯•æ–¹æ³•**
   - 5 é˜¶æ®µæµ‹è¯•æµç¨‹æœ‰æ•ˆ
   - è‡ªä¸‹è€Œä¸Šçš„æµ‹è¯•ç­–ç•¥æ­£ç¡®

2. **é€æ­¥è°ƒè¯•**
   - ä»ç®€å•æµ‹è¯•å›¾æ¡ˆå¼€å§‹
   - é€æ­¥å¢åŠ å¤æ‚åº¦
   - æ¯æ­¥éªŒè¯ç»“æœ

3. **è¯¦ç»†æ–‡æ¡£**
   - è®°å½•æ¯ä¸ªæ­¥éª¤
   - ä¾¿äºå›æº¯å’Œåˆ†æ
   - å¸®åŠ©ç†è§£é—®é¢˜

4. **GitHub ç®¡ç†**
   - åŠæ—¶åˆ›å»º issues
   - è®°å½•ä¿®å¤è¿‡ç¨‹
   - ä¾¿äºè¿½è¸ªè¿›åº¦

### é‡åˆ°çš„æŒ‘æˆ˜

1. **Chisel ç¼–è¯‘å™¨ä¼˜åŒ–**
   - ä¿¡å·è¢«ä¼˜åŒ–æ‰
   - éœ€è¦ `dontTouch` é˜²æ­¢

2. **SyncReadMem å»¶è¿Ÿ**
   - è¯»å–æœ‰ä¸€ä¸ªå‘¨æœŸå»¶è¿Ÿ
   - éœ€è¦å»ºç«‹æ­£ç¡®çš„ç®¡é“

3. **è°ƒè¯•å›°éš¾**
   - ç¡¬ä»¶ä»¿çœŸéš¾ä»¥å•æ­¥è°ƒè¯•
   - éœ€è¦æ›´å¤šè°ƒè¯•å·¥å…·

### æ”¹è¿›å»ºè®®

1. æ·»åŠ æ›´å¤šè°ƒè¯•è¾“å‡º
2. å®ç° VCD æ³¢å½¢è®°å½•
3. åˆ›å»ºæ›´å¤šå•å…ƒæµ‹è¯•
4. æ”¹è¿›é”™è¯¯æç¤ºä¿¡æ¯

---

## ğŸ“ˆ é¡¹ç›®é‡Œç¨‹ç¢‘

### å·²å®Œæˆ

- âœ… v0.1.0: CPU åŸºæœ¬å®ç°
- âœ… v0.2.0: CPU æŒ‡ä»¤é›†å®Œæˆ
- âœ… v0.3.0: PPU åŸºç¡€æ¡†æ¶
- âœ… v0.4.0: NES ç³»ç»Ÿé›†æˆ
- âœ… v0.5.0: Mapper 0/4 æ”¯æŒ
- âœ… v0.6.0: Verilator ä»¿çœŸ
- âœ… v0.7.0: æ¸¸æˆå¯åŠ è½½
- âœ… v0.8.0: PPU æ¸²æŸ“å·¥ä½œ â­ å½“å‰ç‰ˆæœ¬

### è®¡åˆ’ä¸­

- â³ v0.9.0: è¾“å…¥ç³»ç»Ÿå®Œæˆ
- â³ v1.0.0: ç¬¬ä¸€ä¸ªæ¸¸æˆå®Œå…¨å¯ç©
- â³ v1.1.0: APU éŸ³é¢‘æ”¯æŒ
- â³ v1.2.0: å¤šæ¸¸æˆå…¼å®¹
- â³ v2.0.0: 60 FPS + å®Œæ•´åŠŸèƒ½

---

## ğŸ‰ æ€»ç»“

### ä¸»è¦æˆå°±

1. **æˆåŠŸä¿®å¤ PPU æ¸²æŸ“** - ä»ç°è‰²åˆ°æœ‰å›¾å½¢
2. **æ€§èƒ½ä¼˜å¼‚** - FPS 36-37ï¼Œè¿œè¶…ç›®æ ‡
3. **ç³»ç»Ÿç¨³å®š** - é•¿æ—¶é—´è¿è¡Œæ— å´©æºƒ
4. **å®Œæ•´æ–‡æ¡£** - è¯¦ç»†è®°å½•æ‰€æœ‰è¿‡ç¨‹

### æ•´ä½“è¯„ä¼°

**é¡¹ç›®çŠ¶æ€**: ğŸŸ¡ Alpha é˜¶æ®µ
- æ ¸å¿ƒåŠŸèƒ½åŸºæœ¬å®Œæˆ
- èƒ½æ˜¾ç¤ºæ¸¸æˆç”»é¢
- éœ€è¦å®Œå–„è¾“å…¥å’Œç²¾çµæ¸²æŸ“
- è·ç¦»å®Œå…¨å¯ç©è¿˜æœ‰ä¸€æ­¥ä¹‹é¥

**å…¼å®¹æ€§**: 60% (åŸºæœ¬å…¼å®¹)
- èƒ½åŠ è½½å’Œè¿è¡Œæ¸¸æˆ
- èƒ½æ˜¾ç¤ºå›¾å½¢å’Œé¢œè‰²
- è¾“å…¥ç³»ç»Ÿå¾…å®ç°
- éƒ¨åˆ†åŠŸèƒ½å¾…å®Œå–„

**æ¨èåº¦**: â­â­â­â­â˜† (4/5)
- é€‚åˆå­¦ä¹ å’Œç ”ç©¶
- å±•ç¤ºäº†å®Œæ•´çš„ NES æ¶æ„
- æ€§èƒ½ä¼˜ç§€
- æ–‡æ¡£å®Œå–„

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-11-29 16:43  
**ç‰ˆæœ¬**: v0.8.0-alpha  
**ä¸‹æ¬¡æ›´æ–°**: å®ç°è¾“å…¥ç³»ç»Ÿå
