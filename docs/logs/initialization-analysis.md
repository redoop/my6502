# Donkey Kong 初始化分析

## 观察结果

### 长时间运行数据
- **运行时间**: ~4 分钟
- **总帧数**: ~7156 帧
- **平均 FPS**: 28-29.5
- **CPU 状态**: 仍在 0xf1a0-0xf1a7 循环
- **PPUMASK**: 保持在 0x6
- **渲染状态**: 未启用

## 问题分析

### 1. 初始化循环过长
游戏在 PC 0xf1a0-0xf1a7 执行延迟循环，已经运行了 7000+ 帧，但仍未退出。

### 2. PPUMASK 状态
- 当前值: 0x6 (bit 1 和 bit 2)
- 需要值: 0x18 (bit 3 和 bit 4)
- 状态: 长时间保持不变

### 3. 可能的原因

#### A. 游戏等待特定条件
游戏可能在等待：
- 特定的帧数计数
- PPU 状态标志
- 控制器输入
- 其他硬件状态

#### B. CPU 实现问题
可能存在的问题：
- 某个指令实现不正确
- 标志位更新有误
- 中断处理问题
- 时序问题

#### C. PPU 实现问题
可能的问题：
- VBlank 标志不正确
- PPU 状态寄存器读取有误
- NMI 中断未正确触发

## 调试策略

### 方案 1: 深入分析循环代码
反汇编 0xf1a0-0xf1a7 的代码，理解循环的退出条件。

```bash
# 需要创建一个脚本来分析这段代码
bash scripts/analyze_loop_code.sh
```

### 方案 2: 监控关键寄存器变化
跟踪可能影响循环退出的寄存器：
- PPU 状态寄存器
- 帧计数器
- 内存特定位置

### 方案 3: 尝试不同的 ROM
测试其他更简单的 ROM（如 Super Mario Bros），看是否有同样的问题。

### 方案 4: 强制跳过初始化
修改 testbench，在特定帧数后强制设置 PPUMASK = 0x18，测试渲染功能。

### 方案 5: 检查 NMI 中断
游戏可能依赖 NMI 中断来推进状态，需要验证 NMI 是否正确触发。

## 推荐行动

### 立即行动
1. **检查 NMI 中断**: 验证 VBlank 时 NMI 是否正确触发
2. **监控内存变化**: 看看游戏是否在更新某些内存位置
3. **测试其他 ROM**: 尝试 Super Mario Bros

### 短期行动
1. 反汇编循环代码，理解退出条件
2. 添加更详细的调试输出
3. 检查 CPU 指令实现的正确性

### 长期行动
1. 实现完整的 PPU 功能
2. 优化性能到 60 FPS
3. 支持更多游戏

## 快速测试命令

### 检查 NMI 状态
```bash
# 创建一个脚本来监控 NMI
bash scripts/monitor_nmi.sh
```

### 测试 Super Mario Bros
```bash
./build/verilator_opt/obj_dir/VNESSystem games/Super-Mario-Bros.nes
```

### 强制启用渲染测试
```bash
# 修改 testbench 在第 100 帧强制设置 PPUMASK = 0x18
# 这样可以测试渲染功能是否正常
```

## 结论

游戏的初始化循环比预期长得多。需要进一步调试来确定：
1. 循环是否会自然退出
2. 是否存在 CPU/PPU 实现问题
3. 游戏是否在等待特定的硬件状态

建议先检查 NMI 中断和测试其他 ROM，以缩小问题范围。
